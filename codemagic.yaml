workflows:
  ios-ipa:
    name: Build iOS IPA (Flutter + Supabase + AI Features)
    environment:
      flutter: 3.32.5
      xcode: 15.0
      vars:
        GEMINI_API_KEY: $GEMINI_API_KEY
    scripts:
      - name: Checkout source
        script: |
          echo "✅ Source code checked out"

      - name: Create .env file
        script: |
          echo "GEMINI_API_KEY=$GEMINI_API_KEY" > .env
          echo "# Environment variables for CI/CD build" >> .env
          if [ -f .env ]; then
            echo "✅ .env file created successfully"
            sed 's/=.*/=***REDACTED***/g' .env
          else
            echo "⚠️ .env file not found - app will use fallback mode"
          fi

      - name: Install dependencies
        script: |
          flutter pub get

      - name: Prepare iOS Pods
        script: |
          cd ios
          pod repo update
          pod install

      - name: Precache iOS
        script: |
          flutter precache --ios

      - name: Build iOS app (unsigned)
        script: |
          flutter build ios --release --no-codesign

      - name: Package IPA
        script: |
          cd build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload
          zip -qq -r -9 FlutterIpaExport.ipa Payload

      - name: Create build info
        script: |
          cd build/ios/iphoneos
          echo "# Build Information" > build_info.txt
          echo "Build Date: $(date)" >> build_info.txt
          echo "Flutter Version: 3.32.5" >> build_info.txt
          echo "Platform: iOS" >> build_info.txt
          echo "Features: File Summarization, AI Integration" >> build_info.txt
          echo "API Support: Gemini AI (configured via secrets)" >> build_info.txt
          echo "Build Number: $CM_BUILD_ID" >> build_info.txt

    artifacts:
      - build/ios/iphoneos/FlutterIpaExport.ipa
      - build/ios/iphoneos/build_info.txt
